---
- name: Création des containers
  lxd_container:
    name: "{{ item.name }}"
    state: started
    source:
      type: image
      mode: pull
      server: https://images.linuxcontainers.org
      protocol: simplestreams
      alias: "{{ item.alias }}"
    profiles: "{{ item.profiles | default({}) }}"
    devices: "{{ item.devices | default({}) }}"
    wait_for_ipv4_addresses: true
  with_items: "{{ lxd_containers }}"
  when: "lxd_containers is defined"
  register: add_lxd_container

- name: Ajout des containers créés à l'inventaire dynamique
  add_host:
    name: "{{ item.item.name }}"
    ansible_connection: lxd
  with_items: "{{ add_lxd_container.results }}"
  when: "'create' in item.actions"
  changed_when: None
  loop_control:
    label: "{{ item.item.name }}"

- name: Installation de python sur les containers
  raw: |
    test -e /etc/redhat-release && manager='yum'
    test -e /etc/debian_version && manager='apt-get' && extra='ca-certificates'
    test -e /usr/bin/python && $manager -y install python $extra
  with_items: "{{ lxd_containers }}"
  delegate_to: "{{ item.name }}" 
  changed_when: false
